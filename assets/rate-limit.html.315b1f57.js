import{_ as t}from"./plugin-vue_export-helper.21dcd24c.js";import{r as e,o as p,c as o,a as n,b as c,d as s,e as i}from"./app.c099355f.js";const l={},u=n("h3",{id:"\u9650\u6D41",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u9650\u6D41","aria-hidden":"true"},"#"),s(" \u9650\u6D41")],-1),r=n("p",null,[s("\u9650\u6D41\u5C31\u662F\u5BF9\u8BF7\u6C42\u8FDB\u884C\u63A7\u5236\u548C\u8C03\u5EA6\u3002\u8FD9\u6837\u505A\u6709\u52A9\u4E8E\u9632\u6B62\u7CFB\u7EDF\u8D1F\u8F7D\u8FC7\u5927\u5BFC\u81F4\u5D29\u6E83\u6216\u6027\u80FD\u4E0B\u964D\u7B49\u60C5\u51B5\u3002\u4F8B\u5982\u6211\u53EF\u4EE5\u5BF9\u4E1A\u52A1\u4E2D\u6838\u5FC3\u7684"),n("code",null,"\u67E5\u8BE2\u529F\u80FD"),s("\u8FDB\u884C\u9650\u6D41\uFF0C\u4FDD\u8BC1\u8FD9\u4E2A\u63A5\u53E3\u4E00\u5206\u949F\u6700\u5927\u5141\u8BB8100\u6B21\u8BF7\u6C42(100/minutes)\u3002")],-1),k=n("p",null,[s("\u968F\u7740\u4E1A\u52A1\u7684\u8C03\u6574\uFF0C\u5F15\u5165\u4E86\u4F1A\u5458\u673A\u5236\uFF0C\u5C0A\u8D35\u7684"),n("code",null,"\u4EBA\u6C11\u5E01\u73A9\u5BB6"),s('\u53EF\u4E0D\u80FD\u4E5F"\u4EAB\u53D7"\u7740\u9650\u6D41\u7684\u5F85\u9047\u3002\u4F46\u53C8\u4E0D\u80FD\u5168\u9762\u653E\u5F00\u5BFC\u81F4\u63A5\u53E3\u88AB\u533F\u540D\u672A\u767B\u5F55\u6216\u8005\u666E\u901A\u7528\u6237\u4E00\u6837\u65E0\u9650\u5237\u8BBF\u95EE\u3002\u4E8E\u662F\u9700\u8981\u5BF9\u4E0D\u540C\u7684\u89D2\u8272\u8FDB\u884C\u4E0D\u540C\u7684\u9650\u6D41\u3002')],-1),d=n("h3",{id:"fastapi-limiter",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#fastapi-limiter","aria-hidden":"true"},"#"),s(" fastapi_limiter")],-1),v=s("\u8C03\u7814fastapi\u9650\u6D41\u5E93\uFF0CGoogle\u641C\u7D22\u6392\u540D\u7B2C\u4E00\u662F"),m={href:"https://github.com/long2ice/fastapi-limiter",target:"_blank",rel:"noopener noreferrer"},b=s("fastapi-limiter"),y=s("\uFF0C\u7B80\u5355\u770B\u4E86\u4E00\u4E0B\u5B83\u7684\u4F7F\u7528\u53CA\u6587\u6863\uFF0C\u53D1\u73B0\u5B83\u7684\u5E94\u7528\u53EA\u5C40\u9650\u4E8E\u5BF9\u63A5\u53E3\u7684\u65F6\u95F4\u533A\u95F4\u5185\u7684\u9650\u5236\u3002"),_=i(`<div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> redis<span class="token punctuation">.</span>asyncio <span class="token keyword">as</span> redis
<span class="token keyword">import</span> uvicorn
<span class="token keyword">from</span> fastapi <span class="token keyword">import</span> Depends<span class="token punctuation">,</span> FastAPI

<span class="token keyword">from</span> fastapi_limiter <span class="token keyword">import</span> FastAPILimiter
<span class="token keyword">from</span> fastapi_limiter<span class="token punctuation">.</span>depends <span class="token keyword">import</span> RateLimiter

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>on_event</span><span class="token punctuation">(</span><span class="token string">&quot;startup&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    redis <span class="token operator">=</span> redis<span class="token punctuation">.</span>from_url<span class="token punctuation">(</span><span class="token string">&quot;redis://localhost&quot;</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> FastAPILimiter<span class="token punctuation">.</span>init<span class="token punctuation">(</span>redis<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> dependencies<span class="token operator">=</span><span class="token punctuation">[</span>Depends<span class="token punctuation">(</span>RateLimiter<span class="token punctuation">(</span>times<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> seconds<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">}</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">&quot;main:app&quot;</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">reload</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5B83\u901A\u8FC7\u4F9D\u8D56\u7ED1\u5B9A\u5728\u63A5\u53E3\u4E2D\uFF0C\u5E76\u8BBE\u7F6E\u4E865\u79D2\u5185\u53EA\u5141\u8BB82\u6B21\u8BF7\u6C42\u3002</p><p>\u800C\u5B83\u6A21\u5757\u7684\u6838\u5FC3\u5B9E\u73B0\u662F\u901A\u8FC7<code>redis</code>\u7684<code>lua</code>\u811A\u672C\u5B9E\u73B0\u7684\uFF0C\u6211\u5BF9\u5176\u505A\u4E86\u8BE6\u7EC6\u7684\u6CE8\u91CA\u3002</p><div class="language-lua ext-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- \u83B7\u53D6\u4F20\u9012\u7ED9Lua\u811A\u672C\u7684\u7B2C\u4E00\u4E2Akey\u3002</span>
<span class="token keyword">local</span> key <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- \u4ECE\u53C2\u6570\u5217\u8868\u4E2D\u83B7\u53D6\u9650\u5236\u6570\u91CF\uFF0C\u5E76\u5C06\u5176\u8F6C\u6362\u4E3A\u6570\u5B57\u683C\u5F0F\u3002</span>
<span class="token keyword">local</span> limit <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">-- \u4ECE\u53C2\u6570\u5217\u8868\u4E2D\u83B7\u53D6\u8FC7\u671F\u65F6\u95F4\u4F5C\u4E3A\u6BEB\u79D2</span>
<span class="token keyword">local</span> expire_time <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token comment">-- \u5C1D\u8BD5\u4ECEredis\u6570\u636E\u5E93\u8BFB\u53D6\u5F53\u524D\u8BA1\u6570\u5668\uFF0C\u5982\u679C\u4E0D\u5B58\u5728\u5219\u8FD4\u56DE0.</span>
<span class="token keyword">local</span> current <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> current <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
    <span class="token comment">-- \u5982\u679C\u5F53\u524D\u8BA1\u6570\u5668\u5927\u4E8E0\uFF0C\u5219\u5C06\u8BA1\u6570\u5668\u52A01</span>
    <span class="token keyword">if</span> current <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> limit <span class="token keyword">then</span>
        <span class="token comment">-- \u8D85\u8FC7\u9608\u503C\uFF0C\u5219\u8FD4\u56DEredis\u952E\u5269\u4F59\u751F\u5B58\u65F6\u95F4</span>
        <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;PTTL&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token comment">-- \u672A\u8D85\u8FC7\u9608\u503C\uFF0C\u5219\u5C06\u8BA1\u6570\u5668\u52A01</span>
        redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;INCR&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">end</span>
<span class="token keyword">else</span>
    <span class="token comment">-- \u521D\u59CB\u5316\u8BA1\u6570\u5668\uFF0C\u8BBE\u7F6E\u4E3A1\uFF0C\u5E76\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;SET&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">,</span> expire_time<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token keyword">end</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u4E0A<code>lua</code>\u811A\u672C\u4E00\u65E6\u8FD4\u56DE\u503C\u4E0D\u4E3A\u96F6\uFF0C\u5C31\u610F\u5473\u7740\u63A5\u53E3\u9650\u5236\uFF0C\u8FD4\u56DE\u503C\u5C31\u662F\u5269\u4F59\u65F6\u95F4\u3002</p><p><img src="https://miclon-job.oss-cn-hangzhou.aliyuncs.com/img/20230415233817.png" alt="" loading="lazy"></p><p>\u800C\u4E8B\u5B9E\u4E0A\uFF0C\u6E90\u7801\u4E2D\u4E5F\u662F\u8FD9\u4E48\u505A\u7684\uFF0C\u4E00\u65E6\u4E0D\u4E3A\u96F6\uFF0C\u5C31\u89E6\u53D1\u5F02\u5E38\u7684callback\uFF0C\u5728callback\u4E2D\u8FD4\u56DE<code>HTTPException</code>\u3002</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">http_default_callback</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> response<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> pexpire<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    expire <span class="token operator">=</span> ceil<span class="token punctuation">(</span>pexpire <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token keyword">raise</span> HTTPException<span class="token punctuation">(</span>
        HTTP_429_TOO_MANY_REQUESTS<span class="token punctuation">,</span> <span class="token string">&quot;Too Many Requests&quot;</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;Retry-After&quot;</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>expire<span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u6B64\u6A21\u5757\u7684\u57FA\u7840\u4E0A\uFF0C\u6211\u4EEC\u53EF\u4EE5\u57FA\u4E8E\u5B83\u7684\u5B9E\u73B0\uFF0C\u5C01\u88C5\u5BF9\u4E0D\u540C\u7684\u89D2\u8272\u8FDB\u884C\u4E0D\u540C\u7684\u9650\u6D41\u3002</p><h3 id="\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#\u5B9E\u73B0" aria-hidden="true">#</a> \u5B9E\u73B0</h3><p>\u9996\u5148\uFF0C\u6211\u4EEC\u9700\u8981\u5BF9\u4E0D\u540C\u7684\u89D2\u8272\u8FDB\u884C\u9650\u6D41\uFF0C\u90A3\u4E48\u6211\u4EEC\u9700\u8981\u77E5\u9053\u5F53\u524D\u8BF7\u6C42\u7684\u7528\u6237\u89D2\u8272\u3002\u5F80\u5F80\u9879\u76EE\u4E2D\u662F\u901A\u8FC7<code>jwt</code>\u6216\u8005<code>session</code>\u6765\u5B9E\u73B0\u7684\uFF0C\u6211\u8FD9\u91CC\u7B80\u5355\u4F7F\u7528headers\u4E2D\u7684<code>token</code>\u6765\u6A21\u62DF\u7528\u6237\u7684\u89D2\u8272\u3002</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">BaseUser</span><span class="token punctuation">:</span>
    rate_limit <span class="token operator">=</span> <span class="token boolean">None</span>


<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>BaseUser<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;\u666E\u901A\u5DF2\u767B\u5F55\u7528\u6237\uFF0C\u5341\u79D2\u5185\u5141\u8BB85\u6B21\u8BF7\u6C42&quot;&quot;&quot;</span>
    rate_limit <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;times&quot;</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token string">&quot;seconds&quot;</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">AnonymousUser</span><span class="token punctuation">(</span>BaseUser<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;\u533F\u540D\u672A\u767B\u5F55\u7528\u62373\u79D2\u53EA\u5141\u8BB81\u6B21\u8BBF\u95EE&quot;&quot;&quot;</span>
    rate_limit <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;times&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">&quot;seconds&quot;</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">VIPUser</span><span class="token punctuation">(</span>BaseUser<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;vip\u7528\u6237\uFF0C\u4E0D\u9650\u5236\u8BF7\u6C42&quot;&quot;&quot;</span>


<span class="token comment"># mock\u5F53\u524D\u7528\u6237</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_current_user</span><span class="token punctuation">(</span>token<span class="token operator">=</span>Header<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> token <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> AnonymousUser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> token <span class="token operator">==</span> <span class="token string">&#39;vip&#39;</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> VIPUser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> User<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">UserRateLimiter</span><span class="token punctuation">(</span>RateLimiter<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">&quot;&quot;&quot;
  \u6839\u636E\u7528\u6237\u89D2\u8272\u533A\u5206\u9650\u6D41
  &quot;&quot;&quot;</span>

  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> times<span class="token punctuation">:</span> conint<span class="token punctuation">(</span>ge<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> milliseconds<span class="token punctuation">:</span> conint<span class="token punctuation">(</span>ge<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> seconds<span class="token punctuation">:</span> conint<span class="token punctuation">(</span>ge<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                minutes<span class="token punctuation">:</span> conint<span class="token punctuation">(</span>ge<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> hours<span class="token punctuation">:</span> conint<span class="token punctuation">(</span>ge<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> identifier<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
                callback<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>times<span class="token punctuation">,</span> milliseconds<span class="token punctuation">,</span> seconds<span class="token punctuation">,</span> minutes<span class="token punctuation">,</span> hours<span class="token punctuation">,</span> identifier<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>times <span class="token operator">=</span> times
      self<span class="token punctuation">.</span>seconds <span class="token operator">=</span> seconds
      self<span class="token punctuation">.</span>minutes <span class="token operator">=</span> minutes
      self<span class="token punctuation">.</span>hours <span class="token operator">=</span> hours
      self<span class="token punctuation">.</span>_milliseconds <span class="token operator">=</span> milliseconds

  <span class="token decorator annotation punctuation">@property</span>
  <span class="token keyword">def</span> <span class="token function">milliseconds</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> self<span class="token punctuation">.</span>_milliseconds <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>seconds <span class="token operator">+</span> <span class="token number">60000</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>minutes <span class="token operator">+</span> <span class="token number">3600000</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>hours

  <span class="token decorator annotation punctuation">@milliseconds<span class="token punctuation">.</span>setter</span>
  <span class="token keyword">def</span> <span class="token function">milliseconds</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
      self<span class="token punctuation">.</span>_milliseconds <span class="token operator">=</span> value

  <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> response<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> user<span class="token operator">=</span>Depends<span class="token punctuation">(</span>get_current_user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token comment"># \u6839\u636E\u7528\u6237\u89D2\u8272\u8BBE\u7F6E\u9650\u6D41</span>
      <span class="token keyword">if</span> user<span class="token punctuation">.</span>rate_limit<span class="token punctuation">:</span>
          <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> user<span class="token punctuation">.</span>rate_limit<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
              <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__call__<span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u5C06<code>RateLimiter</code>\u8FDB\u884C\u4E86\u5C01\u88C5\uFF0C\u5C06<code>times</code>\u3001<code>seconds</code>\u3001<code>minutes</code>\u3001<code>hours</code>\u7B49\u53C2\u6570\u8BBE\u7F6E\u4E3A\u53EF\u53D8\u7684\uFF0C\u7136\u540E\u6839\u636E\u7528\u6237\u89D2\u8272\u8BBE\u7F6E\u9650\u6D41\u3002</p><p>\u6839\u636E\u5BF9<code>RateLimiter</code>\u6E90\u7801\u89E3\u8BFB\uFF0C\u4E3B\u8981\u662F\u628A\u65F6\u95F4\u5F52\u4E00\u5316\u5168\u90E8\u8F6C\u4E3A\u6BEB\u79D2\uFF0C\u7136\u540E\u7ED9<code>lua</code>\u811A\u672C\u4F20\u9012\u53C2\u6570\uFF0C\u7528\u4E8E\u68C0\u67E5\u662F\u5426\u8D85\u8FC7\u9650\u5236\u3002</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_check</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    redis <span class="token operator">=</span> FastAPILimiter<span class="token punctuation">.</span>redis
    pexpire <span class="token operator">=</span> <span class="token keyword">await</span> redis<span class="token punctuation">.</span>evalsha<span class="token punctuation">(</span>
        FastAPILimiter<span class="token punctuation">.</span>lua_sha<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>times<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>milliseconds<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> pexpire
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6240\u4EE5\uFF0C\u63A7\u5236<code>times</code>\u548C<code>milliseconds</code>\u5C31\u53EF\u4EE5\u63A7\u5236\u9650\u6D41\u3002</p><p>\u968F\u540E\u6211\u4EEC\u5728\u63A5\u53E3\u4E0A\u7ED1\u5B9A<code>UserRateLimiter</code>\uFF0C\u5C31\u53EF\u4EE5\u5B9E\u73B0\u5BF9\u4E0D\u540C\u7528\u6237\u89D2\u8272\u7684\u9650\u6D41\u4E86\u3002</p><div class="language-python ext-py line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> Depends
<span class="token keyword">from</span> fastapi_limiter <span class="token keyword">import</span> FastAPILimiter
<span class="token keyword">from</span> redis <span class="token keyword">import</span> asyncio

<span class="token keyword">from</span> depends<span class="token punctuation">.</span>user_limiter <span class="token keyword">import</span> UserRateLimiter

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dependencies<span class="token operator">=</span><span class="token punctuation">[</span>Depends<span class="token punctuation">(</span>UserRateLimiter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;pass&quot;</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>on_event</span><span class="token punctuation">(</span><span class="token string">&quot;startup&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pool <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ConnectionPool<span class="token punctuation">.</span>from_url<span class="token punctuation">(</span>
        <span class="token string">&quot;redis://localhost&quot;</span><span class="token punctuation">,</span>
        encoding<span class="token operator">=</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">,</span>
        decode_responses<span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token punctuation">)</span>
    redis <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>connection_pool<span class="token operator">=</span>pool<span class="token punctuation">)</span>
    <span class="token keyword">await</span> FastAPILimiter<span class="token punctuation">.</span>init<span class="token punctuation">(</span>redis<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> uvicorn

    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#\u603B\u7ED3" aria-hidden="true">#</a> \u603B\u7ED3</h3><p>\u672C\u6587\u6211\u4E3B\u8981\u662F\u6211\u5BF9<code>fastapi_limiter</code>\u7684\u6E90\u7801\u89E3\u8BFB\uFF0C\u4EE5\u53CA\u5982\u4F55\u57FA\u4E8E\u5B83\u5B9E\u73B0\u5BF9\u4E0D\u540C\u7528\u6237\u89D2\u8272\u7684\u9650\u6D41\u3002\u601D\u8DEF\u5176\u5B9E\u5F88\u7B80\u5355\uFF0C\u533A\u5206\u89D2\u8272\uFF0C\u914D\u7F6E\u89D2\u8272\u7684\u9650\u6D41\uFF0C\u9650\u6D41\u5668\u6839\u636E\u89D2\u8272\u7684\u9650\u6D41\u914D\u7F6E\u8FDB\u884C\u9650\u6D41\u3002</p>`,21);function f(g,w){const a=e("ExternalLinkIcon");return p(),o("div",null,[u,r,k,d,n("p",null,[v,n("a",m,[b,c(a)]),y]),_])}var x=t(l,[["render",f],["__file","rate-limit.html.vue"]]);export{x as default};
